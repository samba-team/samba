# see https://docs.gitlab.com/ce/ci/yaml/README.html for all available options

stages:
  - images
  - build
  - report

variables:
  GIT_STRATEGY: fetch
  GIT_DEPTH: "3"
  # "--enable-coverage" or ""
  SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE: ""
  #
  # we run autobuild.py inside a samba CI docker image located on gitlab's registry
  # overwrite this variable if you want use your own image registry.
  #
  # Or better ask for access to the shared development repository, see
  # https://wiki.samba.org/index.php/Samba_CI_on_gitlab#Getting_Access
  #
  SAMBA_CI_CONTAINER_REGISTRY: registry.gitlab.com/samba-team/devel/samba
  #
  # Set this to the contents of bootstrap/sha1sum.txt
  # which is generated by bootstrap/template.py --render
  #
  SAMBA_CI_CONTAINER_TAG: 1185fa2a316b3bb7e0c24e9fb8279d4c17450809
  # We use the ubuntu1804 image as default as
  # it matches what we have on sn-devel-184.
  SAMBA_CI_CONTAINER_IMAGE: ubuntu1804
  #
  # The following images are available
  # Please see the samba-o3 sections at the end of this file!
  # We should run that for each available image
  #
  SAMBA_CI_CONTAINER_IMAGE_ubuntu1804: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-ubuntu1804:${SAMBA_CI_CONTAINER_TAG}
  SAMBA_CI_CONTAINER_IMAGE_ubuntu1604: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-ubuntu1604:${SAMBA_CI_CONTAINER_TAG}
  SAMBA_CI_CONTAINER_IMAGE_debian9: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-debian9:${SAMBA_CI_CONTAINER_TAG}
  SAMBA_CI_CONTAINER_IMAGE_opensuse150: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-opensuse150:${SAMBA_CI_CONTAINER_TAG}
  SAMBA_CI_CONTAINER_IMAGE_fedora29: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-fedora29:${SAMBA_CI_CONTAINER_TAG}
  SAMBA_CI_CONTAINER_IMAGE_centos7: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-centos7:${SAMBA_CI_CONTAINER_TAG}

include:
  # The image creation details are specified in a separate file
  # See bootstrap/README.md for details
  - 'bootstrap/.gitlab-ci.yml'

.shared_template:
  variables:
    AUTOBUILD_JOB_NAME: $CI_JOB_NAME
  image: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-${SAMBA_CI_CONTAINER_IMAGE}:${SAMBA_CI_CONTAINER_TAG}
  stage: build
  tags:
    - docker
    - shared
  before_script:
    - uname -a
    - lsb_release -a
    - cat /etc/os-release
    - mount
    - df -h
    - cat /proc/swaps
    - free -h
      # ld will fail if coverage enabled, force link ld to ld.bfd
    - if [ -n "$SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE" ]; then sudo ln -sf $(which ld.bfd) $(which ld); fi
      # See bootstrap/.gitlab-ci.yml how to generate a new image
    - echo "SAMBA_CI_CONTAINER_REGISTRY[${SAMBA_CI_CONTAINER_REGISTRY}]"
    - echo "SAMBA_CI_CONTAINER_TAG[${SAMBA_CI_CONTAINER_TAG}]"
    - bootstrap/template.py --sha1sum > /tmp/sha1sum-template.txt
    - diff -u bootstrap/sha1sum.txt /tmp/sha1sum-template.txt
    - echo "${SAMBA_CI_CONTAINER_TAG}" > /tmp/sha1sum-tag.txt
    - diff -u bootstrap/sha1sum.txt /tmp/sha1sum-tag.txt
    - diff -u bootstrap/sha1sum.txt /sha1sum.txt
  after_script:
    - mount
    - df -h
    - cat /proc/swaps
    - free -h
  artifacts:
    expire_in: 1 week
    paths:
      - "*.stdout"
      - "*.stderr"
      - "*.info"
      - system-info.txt
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  script:
    # gitlab predefines CI_JOB_NAME for each job. The gitlab job usually matches the
    # autobuild name, which means we can define a default template that runs most autobuild jobs
    - echo "Running cmd script/autobuild.py $AUTOBUILD_JOB_NAME $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase"
    - script/autobuild.py $AUTOBUILD_JOB_NAME $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE  --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase

others:
  extends: .shared_template
  script:
    - script/autobuild.py ldb     $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase
    - script/autobuild.py pidl    $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase
    - script/autobuild.py replace $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase
    - script/autobuild.py talloc  $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase
    - script/autobuild.py tdb     $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase
    - script/autobuild.py tevent  $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE --verbose --nocleanup --keeplogs --tail --testbase /tmp/samba-testbase

samba:
  extends: .shared_template

samba-none-env:
  extends: .shared_template

samba-nopython:
  extends: .shared_template

samba-nopython-py2:
  extends: .shared_template

samba-systemkrb5:
  extends: .shared_template

samba-xc:
  extends: .shared_template

samba-ad-member:
  extends: .shared_template

samba-ad-dc-2:
  extends: .shared_template

samba-ad-dc-3:
  extends: .shared_template

samba-ad-dc-4:
  extends: .shared_template

samba-ad-dc-5:
  extends: .shared_template

samba-ad-dc-6:
  extends: .shared_template

samba-ad-dc-backup:
  extends: .shared_template

samba-libs:
  extends: .shared_template

samba-static:
  extends: .shared_template

ctdb:
  extends: .shared_template

samba-ctdb:
  extends: .shared_template

samba-ad-dc-ntvfs:
  extends: .shared_template

.private_template:
  extends: .shared_template
  tags:
    - docker
    - samba-ci-private
  only:
    variables:
      # These jobs are only run if the gitlab repo has private runners available.
      # To enable private jobs, you must add the following var and value to
      # your gitlab repo by navigating to:
      # settings -> CI/CD -> Environment variables
      - $SUPPORT_PRIVATE_TEST == "yes"

samba-fileserver:
  extends: .private_template

samba-ad-dc-1:
  extends: .private_template

samba-nt4:
  extends: .private_template

samba-schemaupgrade:
  extends: .private_template

# 'pages' is a special job which can publish artifacts in `public` dir to gitlab pages
pages:
  image: ${SAMBA_CI_CONTAINER_REGISTRY}/samba-ci-${SAMBA_CI_CONTAINER_IMAGE}:${SAMBA_CI_CONTAINER_TAG}
  stage: report
  tags:
    - docker
    - shared
  dependencies:  # tell gitlab to download artifacts for these jobs
    - samba
    - samba-ad-dc-1
    - samba-ad-dc-2
    - samba-ad-dc-3
    - samba-ad-dc-4
    - samba-ad-dc-5
    - samba-ad-dc-6
    - samba-ad-dc-backup
    - samba-ad-dc-ntvfs
    - samba-ad-member
    - samba-ctdb
    - samba-fileserver
    - samba-libs
    - samba-none-env
    - samba-nopython
    - samba-nopython-py2
    - samba-nt4
    - samba-schemaupgrade
    - samba-static
    - samba-systemkrb5
    - samba-xc
    # - ctdb  # TODO
    - others
  script:
    - ./configure.developer
    - make -j
    - lcov $(ls *.info | xargs -I{} echo -n "-a {} ") -o all.info
    - genhtml all.info --output-directory public --prefix=$(pwd) --title "coverage report for $CI_COMMIT_REF_NAME $CI_COMMIT_SHORT_SHA"
  artifacts:
    expire_in: 30 days
    paths:
      - public
  only:
    variables:
      - $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE == "--enable-coverage"

#
# We build samba-o3 on all supported distributions
#

.samba-o3-template:
  extends: .shared_template
  variables:
    AUTOBUILD_JOB_NAME: samba-o3
  only:
    variables:
      # do not run o3 for coverage since they are using different images
      - $SAMBA_CI_AUTOBUILD_ENABLE_COVERAGE != "--enable-coverage"

ubuntu1804-samba-o3:
  extends: .samba-o3-template
  image: $SAMBA_CI_CONTAINER_IMAGE_ubuntu1804

ubuntu1604-samba-o3:
  extends: .samba-o3-template
  image: $SAMBA_CI_CONTAINER_IMAGE_ubuntu1604

debian9-samba-o3:
  extends: .samba-o3-template
  image: $SAMBA_CI_CONTAINER_IMAGE_debian9

opensuse150-samba-o3:
  extends: .samba-o3-template
  image: $SAMBA_CI_CONTAINER_IMAGE_opensuse150

centos7-samba-o3:
  extends: .samba-o3-template
  image: $SAMBA_CI_CONTAINER_IMAGE_centos7
  variables:
    # Git on CentOS doesn't support shallow git cloning
    GIT_DEPTH: ""

fedora29-samba-o3:
  extends: .samba-o3-template
  image: $SAMBA_CI_CONTAINER_IMAGE_fedora29

#
# Keep the samba-o3 sections at the end ...
#
